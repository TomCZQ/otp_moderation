import { __awaiter } from "tslib";
import { URLSearchParams } from 'url';
import { schemaMap } from './schema';
function removeUndefinedProperty(obj) {
    Object.keys(obj).forEach((key) => {
        if (obj[key] === undefined) {
            delete obj[key];
        }
    });
    return obj;
}
export function generateUrl({ tables, fields, where, joinOn, groupBy, having, orderBy = [{ field: `${tables[0]}._pageName` }], limit = Number.MAX_SAFE_INTEGER, offset = 0, format = 'json', }) {
    return __awaiter(this, void 0, void 0, function* () {
        if (!fields) {
            fields = [];
            for (const table of tables) {
                fields = fields.concat(Object.keys(schemaMap[table]).map((fieldName) => `${table}.${fieldName}`));
            }
        }
        const searchParams = new URLSearchParams(removeUndefinedProperty({
            tables,
            fields,
            where,
            'join on': joinOn === null || joinOn === void 0 ? void 0 : joinOn.map((item) => `${item.left}=${item.right}`),
            'group by': groupBy,
            having,
            'order by': orderBy.map((item) => `${item.field}${item.desc ? ' DESC' : ''}`),
            limit: limit.toString(),
            offset: offset.toString(),
            format,
        }));
        return '/wiki/Special:CargoExport?' + searchParams.toString();
    });
}
