"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.generateUrl = void 0;
const tslib_1 = require("tslib");
const url_1 = require("url");
const schema_1 = require("./schema");
function removeUndefinedProperty(obj) {
    Object.keys(obj).forEach((key) => {
        if (obj[key] === undefined) {
            delete obj[key];
        }
    });
    return obj;
}
function generateUrl({ tables, fields, where, joinOn, groupBy, having, orderBy = [{ field: `${tables[0]}._pageName` }], limit = Number.MAX_SAFE_INTEGER, offset = 0, format = 'json', }) {
    return tslib_1.__awaiter(this, void 0, void 0, function* () {
        if (!fields) {
            fields = [];
            for (const table of tables) {
                fields = fields.concat(Object.keys(schema_1.schemaMap[table]).map((fieldName) => `${table}.${fieldName}`));
            }
        }
        const searchParams = new url_1.URLSearchParams(removeUndefinedProperty({
            tables,
            fields,
            where,
            'join on': joinOn === null || joinOn === void 0 ? void 0 : joinOn.map((item) => `${item.left}=${item.right}`),
            'group by': groupBy,
            having,
            'order by': orderBy.map((item) => `${item.field}${item.desc ? ' DESC' : ''}`),
            limit: limit.toString(),
            offset: offset.toString(),
            format,
        }));
        return '/wiki/Special:CargoExport?' + searchParams.toString();
    });
}
exports.generateUrl = generateUrl;
